{% extends "base.html" %}

{% block title %}Scan Pemasangan / Pelepasan{% endblock %}

{% block content %}
    <h2 class="text-center">Pemasangan & Pelepasan Part (Di Lapangan)</h2>

    <div id="scanner-container" class="card my-4 d-none">
        <div class="card-body text-center">
            <div id="qr-reader" style="width:100%; max-width: 500px; margin: 0 auto;"></div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card p-4 h-100">
                <h4>Pemasangan Part</h4>
                <p class="text-muted small">Untuk part yang statusnya 'Dispatched'.</p>
                <form action="{{ url_for('index') }}" method="POST">
                    <input type="hidden" name="action" value="install">
                    <div class="mb-3">
                        <label for="serial_number_install" class="form-label">Serial Number</label>
                        <input type="text" class="form-control" id="serial_number_install" name="serial_number" required>
                    </div>
                    <div class="mb-3">
                        <label for="equipment_id" class="form-label">Dipasang pada Equipment</label>
                        <select class="form-select" name="equipment_id" required>
                            <option value="" disabled selected>-- Pilih Equipment --</option>
                             {% for eq in equipment_list %}
                                <option value="{{ eq.id }}">{{ eq.equipment_code }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary w-100 mb-2" onclick="startScanner('install')">Scan untuk Pasang</button>
                    <button type="submit" class="btn btn-success w-100">Catat Pemasangan</button>
                </form>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card p-4 h-100">
                <h4>Pelepasan Part</h4>
                <p class="text-muted small">Untuk part yang statusnya 'Installed'.</p>
                <form action="{{ url_for('index') }}" method="POST">
                    <input type="hidden" name="action" value="remove">
                    <div class="mb-3">
                        <label for="serial_number_remove" class="form-label">Serial Number</label>
                        <input type="text" class="form-control" id="serial_number_remove" name="serial_number" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Catatan Pelepasan (Opsional)</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary w-100 mb-2" onclick="startScanner('remove')">Scan untuk Lepas</button>
                    <button type="submit" class="btn btn-danger w-100">Catat Pelepasan</button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}" type="text/javascript"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scannerContainer = document.getElementById('scanner-container');
            const html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);

            window.startScanner = function(mode) {
                scannerContainer.classList.remove('d-none');
                
                const onScanSuccess = (decodedText, decodedResult) => {
                    if (mode === 'install') {
                        document.getElementById('serial_number_install').value = decodedText;
                    } else if (mode === 'remove') {
                        document.getElementById('serial_number_remove').value = decodedText;
                    }
                    alert(`Part ${decodedText} berhasil dipindai!`);
                    
                    if (html5QrcodeScanner.getState() === 2) { // 2 = SCANNING
                        html5QrcodeScanner.clear().catch(error => {
                            console.error("Gagal membersihkan scanner.", error);
                        });
                    }
                    scannerContainer.classList.add('d-none');
                };

                html5QrcodeScanner.render(onScanSuccess, () => {});
            }
        });
    </script>
{% endblock %}
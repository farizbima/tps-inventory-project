{% extends "base.html" %}
{% block title %}Form Pengeluaran Barang{% endblock %}
{% block content %}
    <h2 class="text-center">Form Pengeluaran Barang (Dari Gudang)</h2>
    <p class="text-center">Scan QR Code untuk mengambil part dari gudang.</p>
    
    <div id="scanner-container" class="card my-4">
        <div class="card-body text-center">
            <div id="qr-reader" style="width:100%; max-width: 500px; margin: 0 auto;"></div>
        </div>
    </div>

    <form method="POST" action="/pengeluaran" class="card p-4 mt-4">
        <div class="mb-3">
            <label for="serial_number" class="form-label">Serial Number (terisi otomatis oleh scan)</label>
            <input type="text" class="form-control" id="serial_number" name="serial_number" required readonly>
        </div>
        <div class="mb-3">
            <label for="pic" class="form-label">PIC (Person in Charge)</label>
            <input type="text" class="form-control" id="pic" name="pic" required>
        </div>
        <div class="mb-3">
            <label for="notes" class="form-label">Keterangan (Opsional)</label>
            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
        </div>
        <button type="submit" class="btn btn-warning">Keluarkan dari Gudang</button>
    </form>

    <script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}" type="text/javascript"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);

            function onScanSuccess(decodedText, decodedResult) {
                document.getElementById('serial_number').value = decodedText;
                alert(`Part ${decodedText} berhasil dipindai!`);
                
                // Hentikan dan sembunyikan scanner setelah berhasil
                if (html5QrcodeScanner.getState() === 2) { // 2 = SCANNING
                    html5QrcodeScanner.clear().catch(error => {
                        console.error("Gagal membersihkan scanner.", error);
                    });
                }
                document.getElementById('scanner-container').style.display = 'none';
            }

            html5QrcodeScanner.render(onScanSuccess, () => {});
        });
    </script>
{% endblock %}